{
   "$schema":"http://json-schema.org/draft-04/schema#",

    "description":"This schema represents a medication schedule, based on the prescription e.g., atenolol 50 mg, 1 tablet at 8:00 and and 0.5 tablet at 8 pm for 30 days, with a window of +/- 1 hour.",

    "type":"object",

    "definitions": {
        "medication": {
            "$ref": "medication-1.0.json"
        },
        "medication_route": {
            "$ref": "medication-route-1.0.json"
        },
        "medication_dose_unit_value": {
            "$ref": "medication-dose-unit-value-1.0.json"
        },
        "duration_unit_value": {
            "$ref": "../generic/duration-unit-value-1.0.json"
        },
        "duration_unit_value_range": {
            "$ref": "../generic/duration-unit-value-range-1.0.json"
        },
        "time_frame": {
            "$ref": "../generic/time-frame-2.0.json"
        },
        "day_of_week": {
            "$ref": "../generic/day-of-week-1.0.json"
        },
        "time": {
            "$ref": "../generic/time-1.0.json"
        }
    },

    "properties": {
        "medication":{
            "$ref": "#/definitions/medication"
        },
        "schedule": {
            "type": "array",
            "description": "Each dose must have an associated schedule and acceptable window, hence this is an array.",
            "items": {
                "type": "object",
                "properties": {
                    "dose_duration": {
                        "description": "A medication prescription can last a certain length of time (duration), a certain range of time (duration range), a time frame (one day or a time interval) or as long as a certain condition (e.g., until skin lesion heals). The prescription for a chronic condition continues indeterminately and to indicate this 99 years is used.",
                        "oneOf": [
                            {
                                "$ref": "#/definitions/duration_unit_value"
                            },
                            {
                                "$ref": "#/definitions/duration_unit_value_range"
                            },
                            {
                                "$ref": "#/definitions/time_frame"
                            }
                        ]
                    },
                    "dose_administration_duration": {
                        "description": "the administration of a medication dose can last a certain length of time (duration), a certain range of time (duration range), a time frame (one day or a time interval) or as long as a certain condition (e.g., until skin lesion heals).",
                        "oneOf": [
                            {
                                "$ref": "#/definitions/duration_unit_value"
                            },
                            {
                                "$ref": "#/definitions/duration_unit_value_range"
                            },
                            {
                                "$ref": "#/definitions/time_frame"
                            },
                            {
                                "type": "string"
                            }
                        ]
                    },
                    "dose": {
                        "$ref": "#/definitions/medication_dose_unit_value"
                    },
                    "dose_recurrence": {
                        "anyOf": [
                            {
                                "timing": {
                                    "type": "array",
                                    "description": "A medication dose can have different schedules (dose recurrence), hence this is an array.",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "day_of_week": {
                                                "$ref": "#/definitions/day_of_week"
                                            },
                                            "time_of_day": {
                                                "$ref": "#/definitions/time"
                                            }
                                        }
                                    },
                                    "required": ["time_of_day"]
                                }
                            },
                            {
                                "sequence": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "unit": {
                                                "enum": [
                                                    "min",
                                                    "h",
                                                    "d",
                                                    "wk",
                                                    "Mo",
                                                    "yr"
                                                ]
                                            },

                                            "value": {
                                                "type": "number"
                                            }
                                        }
                                    }
                                }
                            }
                        ]
                    }
                },
                "required": ["dose_duration","dose","dose_recurrence"]
            }
        },
        "acceptable_window": {
            "type": "object",
            "description": "The amount of time before and after the set time during which it is still acceptable to take a dose of the medication. If missing, the dose must be taken at the exact time.",
            "before": {
                "$ref": "#/definitions/duration_unit_value"
            },
            "after":{
                "$ref": "#/definitions/duration_unit_value"
            }
        }
    },

    "required": ["medication","schedule"]
}